/*
 Copyright 2015 Wouter Bulten
 @license GNU LESSER GENERAL PUBLIC LICENSE v3
 @preserve
*/
for(var w="function"==typeof Object.defineProperties?Object.defineProperty:function(p,f,g){p!=Array.prototype&&p!=Object.prototype&&(p[f]=g.value)},C="undefined"!=typeof window&&window===this?this:"undefined"!=typeof global&&null!=global?global:this,H=["Array","prototype","fill"],I=0;I<H.length-1;I++){var J=H[I];J in C||(C[J]={});C=C[J]}
var K=H[H.length-1],Q=C[K],T=Q?Q:function(p,f,g){var d=this.length||0;0>f&&(f=Math.max(0,d+f));if(null==g||g>d)g=d;g=Number(g);0>g&&(g=Math.max(0,d+g));for(f=Number(f||0);f<g;f++)this[f]=p;return this};T!=Q&&null!=T&&w(C,K,{configurable:!0,writable:!0,value:T});
(function(p){function f(d){if(g[d])return g[d].h;var c=g[d]={B:d,o:!1,h:{}};p[d].call(c.h,c,c.h,f);c.o=!0;return c.h}var g={};f.A=p;f.u=g;f.l=function(d,c){f.m(d)||Object.defineProperty(d,"a",{configurable:!1,enumerable:!0,get:c})};f.v=function(d){var c=d&&d.s?function(){return d["default"]}:function(){return d};f.l(c,c);return c};f.m=function(d){return Object.prototype.hasOwnProperty.call(d,"a")};f.w="";return f(f.C=0)})([function(p,f,g){function d(a){var b=document.createElement("canvas"),e=b.getContext("2d"),
l=document.getElementById("brush").width,c=document.getElementById("brush").height;b.width=l;b.height=c;var d=document.getElementById("brushSize").value,h=d/256;e.translate(256-d,256-d);e.scale(h,h);e.clearRect(0,0,l,c);e.fillStyle=x||D;e.fillRect(0,0,l,c);e.globalCompositeOperation="multiply";e.drawImage(a,0,0,l,c);e.globalCompositeOperation="destination-atop";e.drawImage(a,0,0,l,c);return b}function c(a){a.addEventListener("touchstart",function(b){var e={pageX:b.touches[0].pageX,pageY:b.touches[0].pageY};
a.onmousedown&&a.onmousedown(e);b.preventDefault()});a.addEventListener("touchmove",function(b){var e={pageX:b.touches[0].pageX,pageY:b.touches[0].pageY};a.onmousemove&&a.onmousemove(e);b.preventDefault()});a.addEventListener("touchend",function(b){var e={};a.onmouseup&&a.onmouseup(e);a.onmouseout&&a.onmouseout(e);b.preventDefault()})}function z(){var a=m.indexOf(k),b=document.createElement("div"),e=document.createElement("input"),l=document.createElement("canvas"),d=document.createElement("button");
e.type="range";e.value="100";e.min="0";e.max="100";b.appendChild(l);b.appendChild(d);b.appendChild(e);l.width=Math.max(window.innerWidth,window.innerHeight);l.height=Math.max(window.innerWidth,window.innerHeight);l.style.width=document.getElementById("overview").width+"px";l.style.height=document.getElementById("overview").height+"px";var f=l.getContext("2d");f.globalAlpha=1;l.style.display="block";var h={canvas:l,a:f,c:b,opacity:1};m.splice(a,0,h);b.draggable=!0;e.draggable=!1;e.onmousedown=function(){b.draggable=
!1};e.onmouseup=function(){b.draggable=!0};e.l=function(){return!1};e.onmousemove=function(){l.getContext("2d");h.opacity=e.value/100};c(l);b.addEventListener("dragstart",function(a){a.dataTransfer.setData("srcLayer",m.indexOf(k));a.stopPropagation()});b.addEventListener("dragover",function(a){a.preventDefault()});d.type="button";d.innerText="Rotate 90";d.onclick=function(){var a=document.createElement("canvas");a.width=h.canvas.width;a.height=h.canvas.height;var b=a.getContext("2d");b.translate(h.canvas.width/
2,h.canvas.height/2);b.rotate(90*Math.PI/180);b.translate(-h.canvas.width/2,-h.canvas.height/2);b.drawImage(h.canvas,0,0);b=h.a.globalAlpha;var e=h.a.globalCompositeOperation;h.a.globalAlpha=1;h.a.globalCompositeOperation="source-over";h.a.clearRect(0,0,h.canvas.width,h.canvas.height);h.a.drawImage(a,0,0);h.a.globalAlpha=b;h.a.globalCompositeOperation=e};b.addEventListener("drop",function(a){for(var b=a.dataTransfer.getData("srcLayer"),e=0;e<m.length;e++)if(m[e].c===a.currentTarget){b=m.splice(b,
1)[0];m.splice(e,0,b);q();break}a.preventDefault()});l.onmousedown=function(){k=h;q()}.bind(this,h);d=document.getElementById("layerHolder");if(0>a||a+1>=m.length){a=document.createElement("div");f=document.createElement("input");f.id="traceLayer";f.type="checkbox";var g=document.createElement("label");g.innerText="Trace Layer";a.appendChild(f);a.appendChild(g);b.appendChild(a);d.appendChild(b)}else k.c.insertAdjacentElement("afterend",b);k=h;q()}function A(){if(r){var a=m[0].canvas,b=m[0].a.getImageData(0,
0,a.width,a.height),e=4*(r.pageX+r.pageY*a.width);a=b.data[e++];var c=b.data[e++],d=b.data[e++];b=b.data[e++];document.getElementById("rcslider").value=a;document.getElementById("gcslider").value=c;document.getElementById("bcslider").value=d;x="rgba("+a+","+c+","+d+", "+b+")"}}function q(){for(var a=m.indexOf(k),b=0;b<m.length;b++)m[b].canvas.style.border=b===a?"1px solid red":"";b=document.getElementById("layerHolder");var e=document.createElement("div");e.id="layerHolder";m.forEach(function(a){e.appendChild(a.c)});
b.parentNode.replaceChild(e,b);document.getElementById("layerInfo").innerText="Layer "+(a+1)+"/"+m.length}var E=g(1).default,U={g:.1,Q:20,i:20},V={},L=!1,M=null,R=null,S=null,N=null,u=null,r=null,k=null,D="black",F="source-over",v=!1,B=0,t=null,x=null,m=[];console.log(atob("RnJlZHJpayBBbmRlcnNzb24gMjAxNyA8ZnJlZHJpa2FuZGVyc3NvbkBtYWMuY29tPg=="));window.addLayer=z;window.removeLayer=function(){var a=m.indexOf(k);0<=a&&(m.splice(a,1),window.clearLayer(),k.c.parentNode.removeChild(k.c),m.length?k=a<m.length?
m[a]:m[0]:z());q()};window.clearLayer=function(){k.a.clearRect(0,0,k.canvas.width,k.canvas.height);document.getElementById("overview").getContext("2d").clearRect(0,0,document.getElementById("overview").width,document.getElementById("overview").height);document.getElementById("paintlayer").getContext("2d").fillRect(0,0,k.canvas.width,k.canvas.height)};window.exportPng=function(){alert("This feature is broken. Right click the picture and save it instead.");var a=document.getElementById("paintlayer").toDataURL("image/png");
window.href=a};var O="hardBrush";window.liveBrush=!1;window.toggleKalman=function(){L=!L};window.enableEraser=function(){v=!v;document.getElementById("eraseMode").style.border="1px solid red";window.recompileBrush()};window.setBrush=function(a,b){window.activateBrush(a,b)};window.brushes={hardBrush:function(a,b,e,c){a.filter="blur("+B+"px)";a.clearRect(0,0,c.width,c.height);a.beginPath();a.arc(e,e,b,0,2*Math.PI);a.fill()},dotBrush:function(a,b,e,c){a.filter="blur("+B*(window.liveBrush?.001:.2)+"px)";
a.clearRect(0,0,c.width,c.height);for(c=0;c<5*b;c++){a.beginPath();var d=2*Math.random()*b-b,f=2*Math.random()*b-b;Math.sqrt(d*d+f*f)<b&&a.arc(e+d,e+f,.5,0,2*Math.PI);a.fill()}},calligraphyBrush:function(a,b,e,c){var d=1;a.clearRect(0,0,c.width,c.height);a.beginPath();a.lineWidth=b/2;window.liveBrush&&(d=.4,c=Math.random()%360-180,a.rotate(c));a.filter="blur("+B*d+"px)";b/=2;a.strokeStyle=a.fillStyle;a.moveTo(e-b,e-b);a.lineTo(e+b,e+b);a.stroke()},imageBrush:function(a,b,e,c){a.filter="blur("+B+"px)";
a.clearRect(0,0,c.width,c.height);if(null===t){var f=new Image;f.onload=function(){t=f;if(window.liveBrush){var b=Math.random()%360-180;a.translate(document.getElementById("brush").width/2,document.getElementById("brush").width/2);a.rotate(b);a.translate(-document.getElementById("brush").width/2,-document.getElementById("brush").width/2)}a.drawImage(d(t),0,0,document.getElementById("brush").width,document.getElementById("brush").height)};f.src="assets/transp.png"}else window.liveBrush&&(b=Math.random()%
360-180,a.translate(document.getElementById("brush").width/2,document.getElementById("brush").width/2),a.rotate(b),a.translate(-document.getElementById("brush").width/2,-document.getElementById("brush").width/2)),a.drawImage(d(t),0,0,document.getElementById("brush").width,document.getElementById("brush").height)}};var P=!1;window.main=function(){function a(){d&&d();if(0>f--){f=100;var b=document.getElementById("overview"),c=b.getContext("2d");c.clearRect(0,0,b.width,b.height);m.forEach(function(a){c.globalAlpha=
a.opacity;c.drawImage(a.canvas,0,0,b.width,b.height)})}var e=document.getElementById("paintlayer"),h=e.getContext("2d");h.clearRect(0,0,e.width,e.height);m.forEach(function(a){h.globalAlpha=a.opacity;h.drawImage(a.canvas,0,0,e.width,e.height)});window.requestAnimationFrame(a)}function b(){for(var a=0,b,e=document.getElementById("bcslider").value||0,c=255/n.width,d=255/n.height,f=t.getImageData(0,0,n.width,n.height),h=0;h<n.height;h++){for(var g=b=0;g<n.width;g++){var k=4*(g+h*n.width);f.data[k++]=
a;f.data[k++]=b+=c;f.data[k++]=e;f.data[k++]=255}a+=d}t.putImageData(f,0,0)}function e(a,b){v?F="destination-out":(x?y.fillStyle=x:b||D?D=y.fillStyle=x||b||D:y.fillStyle="black",F="source-over");a||(a=document.getElementById("brushSize").value);y.globalAlpha=2*document.getElementById("brushOpacity").value;window.brushes[O](y,a,256,p);document.getElementById("brushSizeText").innerText=a+" px"}document.getElementById("brush").width=512;document.getElementById("brush").height=512;document.onkeydown=
function(a){"Alt"===a.key&&(document.getElementById("palette").style.opacity="0.0",document.getElementById("palette").style.pointerEvents="none",document.getElementById("overviewOverlay").style.opacity="0.0",document.getElementById("overviewOverlay").style.pointerEvents="none")};document.onkeydown=function(a){switch(a.key){case "Alt":P=!0;document.getElementById("palette").style.opacity="0.0";document.getElementById("palette").style.pointerEvents="none";document.getElementById("overviewOverlay").style.opacity=
"0.0";document.getElementById("overviewOverlay").style.pointerEvents="none";break;case "Shift":v=!0,window.recompileBrush()}};document.onkeyup=function(a){switch(a.key){case "Alt":P=!1;document.getElementById("palette").style.opacity="1.0";document.getElementById("palette").style.pointerEvents="all";document.getElementById("overviewOverlay").style.opacity="1.0";document.getElementById("overviewOverlay").style.pointerEvents="all";break;case "Shift":v=!1,window.recompileBrush()}};var d=null,f=100;document.getElementById("fileupload").onchange=
function(){var a=document.getElementById("fileupload").files[0];if(a){a=URL.createObjectURL(a);var b=new Image;b.onload=function(){var a=k.a.globalAlpha;k.a.globalAlpha=1;k.a.drawImage(b,200,0);k.a.globalAlpha=a};b.src=a}};a();var g=!1,h=document.getElementById("paintlayer"),q=document.getElementById("overview"),p=document.getElementById("brush"),n=document.getElementById("colorPalette"),t=n.getContext("2d"),y=p.getContext("2d");q.style.width="100px";q.style.height="100px";q.width=100;q.height=100;
z();h.style.width=h.width=Math.max(window.innerWidth,window.innerHeight);h.style.height=h.height=Math.max(window.innerWidth,window.innerHeight);c(document.getElementById("brushSize"));c(document.getElementById("brushSoft"));c(document.getElementById("brushOpacity"));document.getElementById("brushSoft").onmousemove=function(){B=document.getElementById("brushSoft").value;window.recompileBrush()};document.getElementById("brushSize").onmousemove=function(){e(document.getElementById("brushSize").value)};
document.getElementById("brushOpacity").onmousemove=function(){e()};window.recompileBrush=function(){window.activateBrush(O,window.liveBrush,v)};window.activateBrush=function(a,b,c){v=c;v||(document.getElementById("eraseMode").style.border="");O=a;window.liveBrush=b;y.setTransform(1,0,0,1,0,0);e()};b();var G=!1;c(n);n.onmouseup=function(){G=!1};n.onmousemove=function(a){if(G){var b=t.getImageData(0,0,n.width,n.height),c=4*(Math.min(Math.max(a.offsetX,0),n.width)+Math.min(Math.max(a.offsetY,0),n.height)*
n.width);a=b.data[c++];var d=b.data[c++];b=b.data[c++];document.getElementById("rcslider").value=a;document.getElementById("gcslider").value=d;document.getElementById("bcslider").value=b;e(void 0,"rgb("+a+","+d+","+b+")")}};n.onmouseout=function(){G=!1};n.onmousedown=function(a){G=!0;var b=4*(Math.min(Math.max(a.offsetX,0),n.width)+Math.min(Math.max(a.offsetY,0),n.height)*n.width),c=t.getImageData(0,0,n.width,n.height);a=c.data[b++];var d=c.data[b++];b=c.data[b++];document.getElementById("rcslider").value=
a;document.getElementById("gcslider").value=d;document.getElementById("bcslider").value=b;e(void 0,"rgb("+a+","+d+","+b+")")};c(document.getElementById("rcslider"));c(document.getElementById("gcslider"));c(document.getElementById("bcslider"));document.getElementById("rcslider").onmousemove=document.getElementById("gcslider").onmousemove=function(){e(void 0,"rgb("+document.getElementById("rcslider").value+","+document.getElementById("gcslider").value+","+document.getElementById("bcslider").value+")")};
document.getElementById("bcslider").onmousemove=function(){b();e(void 0,"rgb("+document.getElementById("rcslider").value+","+document.getElementById("gcslider").value+","+document.getElementById("bcslider").value+")")};e(13);q=k.a;q.globalCompositeOperation=F;q.globalAlpha=.1;c(h);h.ontouchmove=function(){};h.onmousedown=function(a){var b=L?U:V;N=new E(b);M=new E(b);S=new E(b);R=new E(b);k.a.globalCompositeOperation=F;if(!g){var c=h.offsetLeft+256,f=h.offsetTop+256;u=r={pageX:a.pageX,pageY:a.pageY};
document.getElementById("traceLayer").checked?(A(),e()):x=null;k.a.globalAlpha=document.getElementById("brushOpacity").value/2;k.a.drawImage(p,a.pageX-c,a.pageY-f);d=g=function(){if(u&&r){var a=parseInt(S.filter(u.pageX)),b=parseInt(N.filter(r.pageX)),d=parseInt(R.filter(u.pageY)),g=parseInt(M.filter(r.pageY));if(a!=b||d!=g){var q=h.offsetLeft+256,m=h.offsetTop+256,n=!1;if(Math.abs(a-b)<Math.abs(d-g)){var l=a;a=d;d=l;l=b;b=g;g=l;n=!0}a>b&&(l=a,a=b,b=l,l=d,d=g,g=l);l=b-a;for(var z=2*Math.abs(g-d),
A=0,t=d;a<=b;a++)!window.liveBrush||a%4||e(),n?k.a.drawImage(p,t-q,a-m):k.a.drawImage(p,a-q,t-m),A+=z,A>l&&(t+=g>d?1:-1,A-=2*l)}else a=k.a.globalAlpha,k.a.globalAlpha=.01,window.liveBrush&&e(),k.a.drawImage(p,N.filter(r.pageX)-c+5*Math.random()-2.5,M.filter(r.pageY)-f+5*Math.random()-2.5),k.a.globalAlpha=a}u=r}}};document.getElementById("overviewOverlay").onmouseleave=function(){};document.getElementById("overviewOverlay").onmouseover=function(){d&&(document.getElementById("overviewOverlay").style.opacity=
"0",document.getElementById("overviewOverlay").style.pointerEvents="none")};document.getElementById("palette").onmouseover=function(){d&&(document.getElementById("palette").style.opacity="0",document.getElementById("palette").style.pointerEvents="none")};h.onmouseup=function(){P||(document.getElementById("palette").style.opacity="1.0",document.getElementById("palette").style.pointerEvents="all",document.getElementById("overviewOverlay").style.opacity="1.0",document.getElementById("overviewOverlay").style.pointerEvents=
"all");g&&(d=null);r=u=g=null};h.onmousemove=function(a){g&&(u&&r||(console.log("setting pos"),r={pageX:a.pageX,pageY:a.pageY},u={pageX:a.pageX,pageY:a.pageY}),r={pageX:a.pageX,pageY:a.pageY})}}},function(p,f){var g=function(){function d(c,d){for(var f=0;f<d.length;f++){var g=d[f];g.enumerable=g.enumerable||!1;g.configurable=!0;"value"in g&&(g.writable=!0);Object.defineProperty(c,g.key,g)}}return function(c,f,g){f&&d(c.prototype,f);g&&d(c,g);return c}}();Object.defineProperty(f,"__esModule",{value:!0});
p=function(){function d(){var c=0>=arguments.length||void 0===arguments[0]?{}:arguments[0],f=c.g,g=c.Q,q=c.f,p=c.i;c=c.b;if(!(this instanceof d))throw new TypeError("Cannot call a class as a function");this.g=void 0===f?1:f;this.Q=void 0===g?1:g;this.f=void 0===q?1:q;this.b=void 0===c?1:c;this.i=void 0===p?0:p;this.x=this.j=NaN}g(d,[{key:"filter",value:function(c){var d=1>=arguments.length||void 0===arguments[1]?0:arguments[1];if(isNaN(this.x))this.x=1/this.b*c,this.j=1/this.b*this.Q*(1/this.b);else{d=
this.f*this.x+this.i*d;var f=this.f*this.j*this.f+this.g,g=1/(this.b*f*this.b+this.Q)*this.b*f;this.x=d+g*(c-this.b*d);this.j=f-g*this.b*f}return this.x}},{key:"lastMeasurement",value:function(){return this.x}},{key:"setMeasurementNoise",value:function(c){this.Q=c}},{key:"setProcessNoise",value:function(c){this.g=c}}]);return d}();f.default=p}]);
