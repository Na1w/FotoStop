/*
 Copyright 2015 Wouter Bulten
 @license GNU LESSER GENERAL PUBLIC LICENSE v3
 @preserve
*/
for(var z="function"==typeof Object.defineProperties?Object.defineProperty:function(n,f,g){n!=Array.prototype&&n!=Object.prototype&&(n[f]=g.value)},D="undefined"!=typeof window&&window===this?this:"undefined"!=typeof global&&null!=global?global:this,K=["Array","prototype","fill"],L=0;L<K.length-1;L++){var M=K[L];M in D||(D[M]={});D=D[M]}
var N=K[K.length-1],W=D[N],Y=W?W:function(n,f,g){var d=this.length||0;0>f&&(f=Math.max(0,d+f));if(null==g||g>d)g=d;g=Number(g);0>g&&(g=Math.max(0,d+g));for(f=Number(f||0);f<g;f++)this[f]=n;return this};Y!=W&&null!=Y&&z(D,N,{configurable:!0,writable:!0,value:Y});
(function(n){function f(d){if(g[d])return g[d].j;var c=g[d]={G:d,v:!1,j:{}};n[d].call(c.j,c,c.j,f);c.v=!0;return c.j}var g={};f.F=n;f.B=g;f.m=function(d,c){f.s(d)||Object.defineProperty(d,"a",{configurable:!1,enumerable:!0,get:c})};f.C=function(d){var c=d&&d.w?function(){return d["default"]}:function(){return d};f.m(c,c);return c};f.s=function(d){return Object.prototype.hasOwnProperty.call(d,"a")};f.D="";return f(f.H=0)})([function(n,f,g){function d(){var a=X.shift();if(a){var b=0,e=document.getElementById("paintlayer");
switch(a.u){case "PAINTSTART":e.onmousedown(a.data.h);break;case "PAINTMOVE":b=a.o-O.o;e.onmousemove(a.data.h);break;case "PAINTSTOP":e.onmouseup(a)}O=a;setTimeout(d,b)}else P=!1}function c(a,b){P||Q.push({o:Date.now(),u:a,data:b})}function r(a){var b=document.createElement("canvas"),e=b.getContext("2d"),p=document.getElementById("brush").width,c=document.getElementById("brush").height;b.width=p;b.height=c;var d=document.getElementById("brushSize").value,h=d/256;e.translate(256-d,256-d);e.scale(h,
h);e.clearRect(0,0,p,c);e.fillStyle=A||E;e.fillRect(0,0,p,c);e.globalCompositeOperation="multiply";e.drawImage(a,0,0,p,c);e.globalCompositeOperation="destination-atop";e.drawImage(a,0,0,p,c);return b}function u(a){a.addEventListener("touchstart",function(b){var e={pageX:b.touches[0].pageX,pageY:b.touches[0].pageY};a.onmousedown&&a.onmousedown(e);b.preventDefault()});a.addEventListener("touchmove",function(b){var e={pageX:b.touches[0].pageX,pageY:b.touches[0].pageY};a.onmousemove&&a.onmousemove(e);
b.preventDefault()});a.addEventListener("touchend",function(b){var e={};a.onmouseup&&a.onmouseup(e);a.onmouseout&&a.onmouseout(e);b.preventDefault()})}function y(){c("NEW_LAYER");var a=m.indexOf(k),b=document.createElement("div"),e=document.createElement("input"),p=document.createElement("canvas"),d=document.createElement("button");e.type="range";e.value="100";e.min="0";e.max="100";b.appendChild(p);b.appendChild(d);b.appendChild(e);p.width=Math.max(window.innerWidth,window.innerHeight);p.height=Math.max(window.innerWidth,
window.innerHeight);p.style.width=document.getElementById("overview").width+"px";p.style.height=document.getElementById("overview").height+"px";var f=p.getContext("2d");f.globalAlpha=1;p.style.display="block";var h={canvas:p,a:f,g:b,opacity:1};m.splice(a,0,h);b.draggable=!0;e.draggable=!1;e.onmousedown=function(){b.draggable=!1};e.onmouseup=function(){b.draggable=!0};e.m=function(){return!1};e.onmousemove=function(){p.getContext("2d");h.opacity=e.value/100};u(p);b.addEventListener("dragstart",function(a){a.dataTransfer.setData("srcLayer",
m.indexOf(k));a.stopPropagation()});b.addEventListener("dragover",function(a){a.preventDefault()});d.type="button";d.innerText="Rotate 90";d.onclick=function(){var a=document.createElement("canvas");a.width=h.canvas.width;a.height=h.canvas.height;var b=a.getContext("2d");b.translate(h.canvas.width/2,h.canvas.height/2);b.rotate(90*Math.PI/180);b.translate(-h.canvas.width/2,-h.canvas.height/2);b.drawImage(h.canvas,0,0);b=h.a.globalAlpha;var e=h.a.globalCompositeOperation;h.a.globalAlpha=1;h.a.globalCompositeOperation=
"source-over";h.a.clearRect(0,0,h.canvas.width,h.canvas.height);h.a.drawImage(a,0,0);h.a.globalAlpha=b;h.a.globalCompositeOperation=e};b.addEventListener("drop",function(a){for(var b=a.dataTransfer.getData("srcLayer"),e=0;e<m.length;e++)if(m[e].g===a.currentTarget){b=m.splice(b,1)[0];m.splice(e,0,b);t();break}a.preventDefault()});p.onmousedown=function(){k=h;t()}.bind(this,h);d=document.getElementById("layerHolder");if(0>a||a+1>=m.length){a=document.createElement("div");f=document.createElement("input");
f.id="traceLayer";f.type="checkbox";var g=document.createElement("label");g.innerText="Trace Layer";a.appendChild(f);a.appendChild(g);b.appendChild(a);d.appendChild(b)}else k.g.insertAdjacentElement("afterend",b);k=h;t()}function F(){if(q){var a=m[0].canvas,b=m[0].a.getImageData(0,0,a.width,a.height),e=4*(q.pageX+q.pageY*a.width);a=b.data[e++];var c=b.data[e++],d=b.data[e++];b=b.data[e++];document.getElementById("rcslider").value=a;document.getElementById("gcslider").value=c;document.getElementById("bcslider").value=
d;A="rgba("+a+","+c+","+d+", "+b+")"}}function t(){for(var a=m.indexOf(k),b=0;b<m.length;b++)m[b].canvas.style.border=b===a?"1px solid red":"";b=document.getElementById("layerHolder");var e=document.createElement("div");e.id="layerHolder";m.forEach(function(a){e.appendChild(a.g)});b.parentNode.replaceChild(e,b);document.getElementById("layerInfo").innerText="Layer "+(a+1)+"/"+m.length}var G=g(1).default,Z={f:.9,Q:60.4,i:1,c:1},aa={f:1,Q:1,i:1,c:1},R=!1,H=null,S=null,T=null,I=null,P=!1,Q=[];window.replayPackets=
Q;var X=[],O=null;window.replay=function(){P=!0;O=null;X=JSON.parse(JSON.stringify(Q));d()};var w=null,q=null,k=null,E="black",J="source-over",x=!1,C=0,v=null,A=null,m=[];console.log(atob("RnJlZHJpayBBbmRlcnNzb24gMjAxNyA8ZnJlZHJpa2FuZGVyc3NvbkBtYWMuY29tPg=="));window.addLayer=y;window.removeLayer=function(){c("REMOVE_LAYER");var a=m.indexOf(k);0<=a&&(m.splice(a,1),window.clearLayer(),k.g.parentNode.removeChild(k.g),m.length?k=a<m.length?m[a]:m[0]:y());t()};window.clearLayer=function(){c("CLEAR_LAYER");
k.a.clearRect(0,0,k.canvas.width,k.canvas.height);document.getElementById("overview").getContext("2d").clearRect(0,0,document.getElementById("overview").width,document.getElementById("overview").height);document.getElementById("paintlayer").getContext("2d").fillRect(0,0,k.canvas.width,k.canvas.height)};window.exportPng=function(){alert("This feature is broken. Right click the picture and save it instead.");var a=document.getElementById("paintlayer").toDataURL("image/png");window.href=a};var U="hardBrush";
window.liveBrush=!1;window.toggleKalman=function(){c("TOGGLE_KALMAN");R=!R};window.enableEraser=function(){c("TOGGLE_ERASER");x=!x;document.getElementById("eraseMode").style.border="1px solid red";window.recompileBrush()};window.setBrush=function(a,b){c("SET_BRUSH",{A:a,I:b});window.activateBrush(a,b)};window.brushes={hardBrush:function(a,b,e,c){a.filter="blur("+C+"px)";a.clearRect(0,0,c.width,c.height);a.beginPath();a.arc(e,e,b,0,2*Math.PI);a.fill()},dotBrush:function(a,b,e,c){a.filter="blur("+C*
(window.liveBrush?.001:.2)+"px)";a.clearRect(0,0,c.width,c.height);for(c=0;c<5*b;c++){a.beginPath();var d=2*Math.random()*b-b,f=2*Math.random()*b-b;Math.sqrt(d*d+f*f)<b&&a.arc(e+d,e+f,.5,0,2*Math.PI);a.fill()}},calligraphyBrush:function(a,b,e,c){var d=1;a.clearRect(0,0,c.width,c.height);a.beginPath();a.lineWidth=b/2;window.liveBrush&&(d=.4,c=Math.random()%360-180,a.rotate(c));a.filter="blur("+C*d+"px)";b/=2;a.strokeStyle=a.fillStyle;a.moveTo(e-b,e-b);a.lineTo(e+b,e+b);a.stroke()},imageBrush:function(a,
b,e,c){a.filter="blur("+C+"px)";a.clearRect(0,0,c.width,c.height);if(null===v){var d=new Image;d.onload=function(){v=d;if(window.liveBrush){var b=Math.random()%360-180;a.translate(document.getElementById("brush").width/2,document.getElementById("brush").width/2);a.rotate(b);a.translate(-document.getElementById("brush").width/2,-document.getElementById("brush").width/2)}a.drawImage(r(v),0,0,document.getElementById("brush").width,document.getElementById("brush").height)};d.src="assets/transp.png"}else window.liveBrush&&
(b=Math.random()%360-180,a.translate(document.getElementById("brush").width/2,document.getElementById("brush").width/2),a.rotate(b),a.translate(-document.getElementById("brush").width/2,-document.getElementById("brush").width/2)),a.drawImage(r(v),0,0,document.getElementById("brush").width,document.getElementById("brush").height)}};var V=!1;window.main=function(){function a(){d&&d();if(0>f--){f=100;var b=document.getElementById("overview"),e=b.getContext("2d");e.clearRect(0,0,b.width,b.height);m.forEach(function(a){e.globalAlpha=
a.opacity;e.drawImage(a.canvas,0,0,b.width,b.height)})}var c=document.getElementById("paintlayer"),h=c.getContext("2d");h.clearRect(0,0,c.width,c.height);m.forEach(function(a){h.globalAlpha=a.opacity;h.drawImage(a.canvas,0,0,c.width,c.height)});window.requestAnimationFrame(a)}function b(){for(var a=0,b,c=document.getElementById("bcslider").value||0,e=255/l.width,d=255/l.height,h=t.getImageData(0,0,l.width,l.height),f=0;f<l.height;f++){for(var g=b=0;g<l.width;g++){var k=4*(g+f*l.width);h.data[k++]=
a;h.data[k++]=b+=e;h.data[k++]=c;h.data[k++]=255}a+=d}t.putImageData(h,0,0)}function e(a,b){x?J="destination-out":(A?B.fillStyle=A:b||E?E=B.fillStyle=A||b||E:B.fillStyle="black",J="source-over");a||(a=document.getElementById("brushSize").value);B.globalAlpha=2*document.getElementById("brushOpacity").value;window.brushes[U](B,a,256,n);document.getElementById("brushSizeText").innerText=a+" px"}document.getElementById("brush").width=512;document.getElementById("brush").height=512;document.onkeyup=function(a){c("KEYUP",
{h:{key:a.key}})};document.onkeydown=function(a){c("KEYDOWN",{h:{key:a.key}})};document.onkeydown=function(a){switch(a.key){case "Alt":V=!0;document.getElementById("palette").style.opacity="0.0";document.getElementById("palette").style.pointerEvents="none";document.getElementById("overviewOverlay").style.opacity="0.0";document.getElementById("overviewOverlay").style.pointerEvents="none";break;case "Shift":x=!0,window.recompileBrush()}};document.onkeyup=function(a){switch(a.key){case "Alt":V=!1;document.getElementById("palette").style.opacity=
"1.0";document.getElementById("palette").style.pointerEvents="all";document.getElementById("overviewOverlay").style.opacity="1.0";document.getElementById("overviewOverlay").style.pointerEvents="all";break;case "Shift":x=!1,window.recompileBrush()}};var d=null,f=100;document.getElementById("fileupload").onchange=function(){var a=document.getElementById("fileupload").files[0];if(a){a=URL.createObjectURL(a);var b=new Image;b.onload=function(){var a=k.a.globalAlpha;k.a.globalAlpha=1;k.a.drawImage(b,200,
0);k.a.globalAlpha=a};b.src=a}};a();var g=!1,h=document.getElementById("paintlayer"),r=document.getElementById("overview"),n=document.getElementById("brush"),l=document.getElementById("colorPalette"),t=l.getContext("2d"),B=n.getContext("2d");r.style.width="100px";r.style.height="100px";r.width=100;r.height=100;y();h.style.width=h.width=Math.max(window.innerWidth,window.innerHeight);h.style.height=h.height=Math.max(window.innerWidth,window.innerHeight);u(document.getElementById("brushSize"));u(document.getElementById("brushSoft"));
u(document.getElementById("brushOpacity"));document.getElementById("brushSoft").onmousemove=function(){C=document.getElementById("brushSoft").value;window.recompileBrush()};document.getElementById("brushSize").onmousemove=function(){e(document.getElementById("brushSize").value)};document.getElementById("brushOpacity").onmousemove=function(){e()};window.recompileBrush=function(){window.activateBrush(U,window.liveBrush,x)};window.activateBrush=function(a,b,c){x=c;x||(document.getElementById("eraseMode").style.border=
"");U=a;window.liveBrush=b;B.setTransform(1,0,0,1,0,0);e()};b();var v=!1;u(l);l.onmouseup=function(){v=!1};l.onmousemove=function(a){if(v){var b=t.getImageData(0,0,l.width,l.height),c=4*(Math.min(Math.max(a.offsetX,0),l.width)+Math.min(Math.max(a.offsetY,0),l.height)*l.width);a=b.data[c++];var d=b.data[c++];b=b.data[c++];document.getElementById("rcslider").value=a;document.getElementById("gcslider").value=d;document.getElementById("bcslider").value=b;e(void 0,"rgb("+a+","+d+","+b+")")}};l.onmouseout=
function(){v=!1};l.onmousedown=function(a){v=!0;var b=4*(Math.min(Math.max(a.offsetX,0),l.width)+Math.min(Math.max(a.offsetY,0),l.height)*l.width),c=t.getImageData(0,0,l.width,l.height);a=c.data[b++];var d=c.data[b++];b=c.data[b++];document.getElementById("rcslider").value=a;document.getElementById("gcslider").value=d;document.getElementById("bcslider").value=b;e(void 0,"rgb("+a+","+d+","+b+")")};u(document.getElementById("rcslider"));u(document.getElementById("gcslider"));u(document.getElementById("bcslider"));
document.getElementById("rcslider").onmousemove=document.getElementById("gcslider").onmousemove=function(){e(void 0,"rgb("+document.getElementById("rcslider").value+","+document.getElementById("gcslider").value+","+document.getElementById("bcslider").value+")")};document.getElementById("bcslider").onmousemove=function(){b();e(void 0,"rgb("+document.getElementById("rcslider").value+","+document.getElementById("gcslider").value+","+document.getElementById("bcslider").value+")")};e(13);r=k.a;r.globalCompositeOperation=
J;r.globalAlpha=.1;u(h);h.ontouchmove=function(){};h.onmousedown=function(a){c("PAINTSTART",{h:{pageX:a.pageX,pageY:a.pageY}});var b=R?Z:aa;I=new G(b);H=new G(b);T=new G(b);S=new G(b);for(b=0;100>b;b++)T.filter(a.pageX,0),I.filter(a.pageX,0),S.filter(a.pageY,0),H.filter(a.pageY,0);k.a.globalCompositeOperation=J;if(!g){var f=h.offsetLeft+256,r=h.offsetTop+256;w=q={pageX:a.pageX,pageY:a.pageY};document.getElementById("traceLayer").checked?(F(),e()):A=null;k.a.globalAlpha=document.getElementById("brushOpacity").value/
2;k.a.drawImage(n,a.pageX-f,a.pageY-r);d=g=function(){if(w&&q){var a=parseInt(T.filter(w.pageX,0)),b=parseInt(I.filter(q.pageX,0)),c=parseInt(S.filter(w.pageY,0)),d=parseInt(H.filter(q.pageY,0));if(a!=b||c!=d){var g=h.offsetLeft+256,u=h.offsetTop+256,m=!1;if(Math.abs(a-b)<Math.abs(c-d)){var l=a;a=c;c=l;l=b;b=d;d=l;m=!0}a>b&&(l=a,a=b,b=l,l=c,c=d,d=l);l=b-a;for(var p=2*Math.abs(d-c),y=0,t=c;a<=b;a++)!window.liveBrush||a%4||e(),m?k.a.drawImage(n,t-g,a-u):k.a.drawImage(n,a-g,t-u),y+=p,y>l&&(t+=d>c?1:
-1,y-=2*l)}else a=k.a.globalAlpha,k.a.globalAlpha=.01,window.liveBrush&&e(),k.a.drawImage(n,I.filter(q.pageX,0)-f+5*Math.random()-2.5,H.filter(q.pageY,0)-r+5*Math.random()-2.5),k.a.globalAlpha=a}w=q}}};document.getElementById("overviewOverlay").onmouseleave=function(){};document.getElementById("overviewOverlay").onmouseover=function(){d&&(document.getElementById("overviewOverlay").style.opacity="0",document.getElementById("overviewOverlay").style.pointerEvents="none")};document.getElementById("palette").onmouseover=
function(){d&&(document.getElementById("palette").style.opacity="0",document.getElementById("palette").style.pointerEvents="none")};h.onmouseup=function(){V||(document.getElementById("palette").style.opacity="1.0",document.getElementById("palette").style.pointerEvents="all",document.getElementById("overviewOverlay").style.opacity="1.0",document.getElementById("overviewOverlay").style.pointerEvents="all");g&&(c("PAINTSTOP"),d=null);q=w=g=null};h.onmousemove=function(a){g&&(c("PAINTMOVE",{h:{pageX:a.pageX,
pageY:a.pageY}}),w&&q||(console.log("setting pos"),q={pageX:a.pageX,pageY:a.pageY},w={pageX:a.pageX,pageY:a.pageY}),q={pageX:a.pageX,pageY:a.pageY})}}},function(n,f){var g=function(){function d(c,d){for(var f=0;f<d.length;f++){var g=d[f];g.enumerable=g.enumerable||!1;g.configurable=!0;"value"in g&&(g.writable=!0);Object.defineProperty(c,g.key,g)}}return function(c,f,g){f&&d(c.prototype,f);g&&d(c,g);return c}}();Object.defineProperty(f,"__esModule",{value:!0});n=function(){function d(){var c=0>=arguments.length||
void 0===arguments[0]?{}:arguments[0],f=c.f,g=c.Q,n=c.c,F=c.i;c=c.b;if(!(this instanceof d))throw new TypeError("Cannot call a class as a function");this.f=void 0===f?1:f;this.Q=void 0===g?1:g;this.c=void 0===n?1:n;this.b=void 0===c?1:c;this.i=void 0===F?0:F;this.x=this.l=NaN}g(d,[{key:"filter",value:function(c){var d=1>=arguments.length||void 0===arguments[1]?0:arguments[1];if(isNaN(this.x))this.x=1/this.b*c,this.l=1/this.b*this.Q*(1/this.b);else{d=this.c*this.x+this.i*d;var f=this.c*this.l*this.c+
this.f,g=1/(this.b*f*this.b+this.Q)*this.b*f;this.x=d+g*(c-this.b*d);this.l=f-g*this.b*f}return this.x}},{key:"lastMeasurement",value:function(){return this.x}},{key:"setMeasurementNoise",value:function(c){this.Q=c}},{key:"setProcessNoise",value:function(c){this.f=c}}]);return d}();f.default=n}]);
